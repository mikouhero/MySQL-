# 12 | SQL 语句为什么变“慢”了

## 1、脏页与干净页
- 脏页  
> 当内存数据页跟磁盘数据页内容不一致时 =》 脏页  
- 干净页  
> 内存数据写入到磁盘后，内存和磁盘上的数据页的内容就一致了 =》干净页
- 刷脏页（flush）可能会导致SQL变慢 \

## 2、刷脏页的场景？
>1、 对应的就是 InnoDB 的 redo log 写满了。这时候系统会停止所有更新操作，把 checkpoint 往前推进，redo log 留出空间可以继续写.
    
>2、内存对应不足。当需要新的内存页时，而内存页不够的时候，就要淘汰一些数据也，空出别的数据页使用  。如果是脏页，就需要先将脏页写到磁盘 ---`为何不直接淘汰内存，从磁盘读入数据页？`  
> 从性能考虑，刷脏页一定写磁盘，就要保证每个数据页的两个状态    
一种是内存里存在，内存里就肯定是正确的结果，直接返回   
内存中没有数据，就可以肯定数据文件上是正确的结果，读入内存后返回，效率最高  

>3、MySQL认定系统空闲的时候会刷新脏页  
>4、MySQL 正常关闭的情况。MySQL 会把内存的脏页都flush到磁盘上，下次启动的时候，直接从磁盘上读取数据，启动熟读更快  

## 3、以上四种情况对性能的影响？
> 第三种情况是属于 MySQL 空闲时的操作，这时系统没什么压力  
> 四种场景是数据库本来就要关闭了,不需要关心  
> 第一种 redo log 写满了 要flush 脏页。这种情况是InnoDB要尽量避免的，出现这种情况的时候，整个系统就不能接收更新了，所有更新会被堵住，从监控上看，更新数会跌为0   
> 第二种 是常态。`InnoDB用缓冲池（buffer pool）管理内存，缓冲池中的内存分为三种状态 `  
- 还未使用 
- 使用了并且是干净页  
- 使用了并且是在脏页 
InnoDB的策略是尽量使用内存，对一个长时间运行的库来说，未被使用的页面很少。  

> 刷脏页虽然是常态，但是出现以下这两种情况，都是会明显影响性能的  
- 一个查询要淘汰的脏页个数太多，会导致查询的响应时间明显变长；
- 日志写满，更新全部堵住，写性能跌为 0，这种情况对敏感业务是不能接受的.

## InnoDB  刷脏页的控制策略 

innodb_io_capacity 这个参数了，它会告诉 InnoDB 你的磁盘能力。这个值我建议你设置成磁盘的 IOPS
                         
InnoDB 的刷盘速度就是要参考这两个因素：一个是脏页比例，一个是 redo log 写盘速度。  
参数 innodb_max_dirty_pages_pct是脏页比例上限，默认值是 75%。InnoDB 会根据当前的脏页比例（假设为 M），算出一个范围在 0 到 100 之间的数字
```html
F1(M)
{
  if M>=innodb_max_dirty_pages_pct then
      return 100;
  return 100*M/innodb_max_dirty_pages_pct;
}

```

InnoDB 每次写入的日志都有一个序号，当前写入的序号跟checkpoint 对应的序号之间的差值，我们假设为 N。InnoDB 会根据这个 N 算出一个范围在 0 到 100 之间的数字，这个计算公式可以记为 F2(N)。F2(N) 算法比较复杂，你只要知道 N 越大，算出来的值越好


在 InnoDB 中，innodb_flush_neighbors参数就是用来控制这个行为的，值为 1 的时候会有“连坐机制“ 值为 0 时表示不找邻居，自己刷自己的。 


                                       




                                  
                              



